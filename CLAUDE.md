# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

**odict** is a standalone Python package that provides an ordered dictionary implementation using an internal double-linked list. This package predates `collections.OrderedDict` and offers unique features, particularly the ability to inherit from different base classes to avoid instance layout conflicts (e.g., when using ZODB's `Persistent` classes).

**Key difference from OrderedDict:** Replacing an existing item keeps it at its original position (insertion order is preserved).

## Package Structure

This is a **single package repository** (not part of the larger Conestack monorepo structure):

```
odict/
├── src/odict/
│   ├── __init__.py       # Exports odict class
│   ├── pyodict.py        # Core implementation (_odict, odict)
│   └── bench.py          # Benchmarking utilities
├── tests/
│   └── test_odict.py     # Comprehensive test suite
├── pyproject.toml        # Package configuration (hatchling)
├── mx.ini                # mxdev/mxmake configuration
└── Makefile              # Generated by mxmake
```

## Common Commands

### Setup and Installation

```bash
# Full install (creates venv, installs dependencies)
make install

# Or step-by-step:
make mxenv        # Create virtual environment at ./venv
make mxfiles      # Generate requirements files
make packages     # Install package in editable mode
```

### Testing

```bash
# Run all tests
make test

# Run coverage (requires 100% coverage)
make coverage

# Run single test
venv/bin/pytest tests/test_odict.py::TestOdict::test_init_with_items
```

### Code Quality

```bash
# Check code style with ruff
make ruff-check

# Auto-format code with ruff
make ruff-format

# Combined check and format
make check format
```

### Cleanup

```bash
# Clean build artifacts (keeps venv and sources)
make clean

# Remove venv
make mxenv-clean

# Clean Python bytecode and caches
make runtime-clean
```

## Core Architecture

### Internal Representation

The odict uses a **double-linked list** stored within dictionary values:

```python
# Each dict value is a 3-element list:
[predecessor_key, actual_value, successor_key]
```

- `self.lh`: Key of the first element (list head)
- `self.lt`: Key of the last element (list tail)
- Links use a special `_nil` sentinel object (not `None`) to mark boundaries

### Class Hierarchy

1. **`_odict`** (abstract base class in `pyodict.py`)
   - Provides the core ordered dict logic
   - Must implement `_dict_impl()` to return the dict class to inherit from
   - Must implement `_list_factory()` to return the list class for internal links
   - Does NOT inherit from dict directly

2. **`odict`** (concrete implementation in `pyodict.py`)
   - Inherits from both `_odict` and `dict`
   - `_dict_impl()` returns `dict`
   - `_list_factory()` returns `list`

### Custom odict Implementations

The abstract `_odict` class allows creating custom ordered dicts for special use cases:

```python
# Example: ZODB-compatible ordered dict
from persistent.dict import PersistentDict
from persistent.list import PersistentList

class podict(_odict, PersistentDict):
    def _dict_impl(self):
        return PersistentDict

    def _list_factory(self):
        return PersistentList
```

This pattern avoids instance layout conflicts when inheriting from both `dict` and other base classes like `Persistent`.

## Build System

Uses **mxmake** with **mxdev**:

- Virtual environment uses **uv** as package installer (faster than pip)
- Minimum Python: **3.10** (configured in Makefile)
- Supports Python: **3.10-3.14** (see pyproject.toml)
- Test framework: **pytest** (configured via `TEST_COMMAND` in Makefile)
- Coverage enforces **100% coverage** of `src/odict` (excluding `bench.py`)

## Python Version Compatibility Notes

- **Python < 3.7**: Casting to dict fails due to Python bug (see README.rst)
  - Use `dict(odict.items())` or `odict.as_dict()` instead of `dict(odict)`

## Testing Notes

- Tests use standard `unittest.TestCase` classes
- Test file: `tests/test_odict.py`
- Tests cover: initialization, item operations, iteration, slicing, pickling, copying, move operations, and custom implementations
