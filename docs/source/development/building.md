# Build System Documentation

## Overview

Codict integrates with the existing mxmake build system through a custom `include.mk` file that provides codict-specific build targets.

## Build System Architecture

### Components

1. **mxmake/mxdev**: Multi-repository build orchestration
2. **Makefile**: Generated by mxmake, includes custom targets
3. **include.mk**: Custom codict build targets (auto-included)
4. **setup.py**: Cython extension configuration
5. **pyproject.toml**: Build dependencies

### Build Flow

```
make install
    ↓
make packages
    ↓
make codict (from include.mk)
    ↓
python setup.py build_ext --inplace
    ↓
Cython compiles codict.pyx → codict.c
    ↓
C compiler builds codict.c → codict.*.so
```

## Configuration Files

### pyproject.toml

Defines build system and dependencies:

```toml
[build-system]
requires = ["hatchling", "cython>=3.0"]
build-backend = "hatchling.build"
```

### setup.py

Configures the Cython extension:

```python
from setuptools import Extension, setup
from Cython.Build import cythonize

extensions = [
    Extension(
        "odict.codict",
        ["src/odict/codict.pyx"],
    )
]

setup(
    name="odict",
    ext_modules=cythonize(
        extensions,
        compiler_directives={
            'language_level': 3,
            'embedsignature': True,
        }
    ),
)
```

**Key settings**:
- `language_level=3`: Use Python 3 syntax
- `embedsignature=True`: Include signatures in docstrings

### include.mk

Custom Makefile targets for codict:

```makefile
CODICT_TARGET:=$(SENTINEL_FOLDER)/codict.sentinel

$(CODICT_TARGET): $(PACKAGES_TARGET)
ifeq ("$(BUILD_CODICT)", "true")
    @echo "Building Cython codict extension"
    @$(MXENV_PYTHON) setup.py build_ext --inplace
    @touch $(CODICT_TARGET)
endif

codict: $(CODICT_TARGET)

codict-clean:
    rm -f $(CODICT_TARGET)
    rm -f src/odict/codict.c
    rm -f src/odict/codict.*.so
    rm -rf build/
```

**Features**:
- Conditional build (controlled by `BUILD_CODICT`)
- Sentinel file prevents unnecessary rebuilds
- Clean target removes all build artifacts
- Automatically included by main Makefile

## Makefile Targets

### Main Targets

#### `make codict`
Build the Cython extension.

```bash
make codict
```

**What it does**:
1. Checks if codict already built (sentinel file)
2. Runs Cython to generate C code
3. Compiles C code to shared library
4. Places `.so` file in `src/odict/`

#### `make codict-clean`
Remove codict build artifacts.

```bash
make codict-clean
```

**Removes**:
- `codict.sentinel` (sentinel file)
- `codict.c` (generated C code)
- `codict.*.so` (compiled extension)
- `build/` directory

#### `make install`
Full installation including codict.

```bash
make install
```

**Steps**:
1. Create virtual environment (`make mxenv`)
2. Checkout sources (`make sources`)
3. Install packages (`make packages`)
4. Build codict (`make codict`)

#### `make clean`
Clean all build artifacts (including codict).

```bash
make clean
```

## Build Options

### Enable/Disable Codict Build

**Enable (default)**:
```bash
BUILD_CODICT=true make install
```

**Disable**:
```bash
BUILD_CODICT=false make install
```

Or set in Makefile:
```makefile
BUILD_CODICT=false
```

### Compiler Flags

**Debug build**:
```bash
CFLAGS="-g -O0" make codict
```

**Optimized build**:
```bash
CFLAGS="-O3 -march=native" make codict
```

**With warnings**:
```bash
CFLAGS="-Wall -Wextra" make codict
```

## Build Artifacts

### Generated Files

After successful build:

```
src/odict/
├── codict.pyx              # Source (not modified)
├── codict.c                # Generated C code (~1.4 MB)
└── codict.*.so             # Compiled extension (~1.9 MB)

build/
├── temp.linux-x86_64-*/    # Temporary object files
└── lib.linux-x86_64-*/     # Temporary library files

.mxmake/
└── sentinels/
    └── codict.sentinel     # Build marker
```

### Platform-Specific Names

**Linux**:
```
codict.cpython-312-x86_64-linux-gnu.so
```

**macOS**:
```
codict.cpython-312-darwin.so
```

**Windows**:
```
codict.cp312-win_amd64.pyd
```

## Troubleshooting Builds

### Build Fails: "Cython not found"

**Solution**:
```bash
pip install "cython>=3.0"
make codict
```

### Build Fails: "compiler not found"

**Linux**:
```bash
sudo apt-get install build-essential
```

**macOS**:
```bash
xcode-select --install
```

**Windows**:
Install Visual Studio Build Tools

### Build Succeeds but Import Fails

**Check extension location**:
```bash
ls -la src/odict/codict*.so
```

**Check Python path**:
```python
import sys
print(sys.path)
```

**Verify correct Python**:
```bash
which python
```

### Rebuild After Changes

**Clean and rebuild**:
```bash
make codict-clean
make codict
```

**Force rebuild**:
```bash
rm -f .mxmake/sentinels/codict.sentinel
make codict
```

## Build Dependencies

### System Dependencies

- Python 3.7+ with development headers
- C compiler (gcc, clang, or MSVC)
- make (for Makefile)

**Ubuntu/Debian**:
```bash
sudo apt-get install python3-dev build-essential
```

**macOS**:
```bash
brew install python
xcode-select --install
```

### Python Dependencies

- `cython>=3.0` (build-time)
- `hatchling` (build backend)

**Install**:
```bash
pip install cython hatchling
```

## CI/CD Integration

### GitHub Actions

Example workflow:

```yaml
name: Build and Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install cython hatchling pytest

      - name: Build extension
        run: |
          python setup.py build_ext --inplace

      - name: Run tests
        run: |
          pytest tests/ -v
```

## Advanced Build Topics

### Debugging Cython Code

**Generate annotated HTML**:
```bash
cython -a src/odict/codict.pyx
# Open codict.html in browser
# Yellow = Python calls (slow)
# White = C code (fast)
```

### Profiling Build

**Time the build**:
```bash
time make codict
```

**Verbose Cython**:
```bash
cython -v src/odict/codict.pyx
```

### Custom Cython Directives

Edit `setup.py`:

```python
compiler_directives={
    'language_level': 3,
    'embedsignature': True,
    'boundscheck': False,  # Disable bounds checking (faster, less safe)
    'wraparound': False,   # Disable negative indexing
    'cdivision': True,     # C-style division
}
```

## Related Documentation

- [Installation Guide](../user-guide/installation.md) - User-facing install docs
- [Development Notes](development.md) - Development workflow
- [Testing](testing.md) - Test after building
